# 生産ポートフォリオ最適化問題

## 概要

エンドフィールドの生産システムにおいて、有限の鉱石採掘レートを最大限活用し、取引券効率を最大化する製品ポートフォリオを求める最適化問題を定式化する。

## 目的関数

**最大化**: 取引券生産レート（券/min）

```
取引券生産レート = Σ(出荷製品iの生産量 × 製品iの取引価格)
```

### 実効利益率との違い

実効利益率（[valley4_analysis.md](valley4_analysis.md) / [wuling_analysis.md](wuling_analysis.md) で算出）は製品間の相対的効率を比較するための指標であり、探索時のヒューリスティックとして有用だが、目的関数そのものではない。

理由:
- 実効利益率が高くても、その製品を大量生産できるとは限らない
- 中間材料として消費される製品は、売却せずに次の生産に回す方が有利な場合がある
- 生産レート制約や鉱石バランスにより、最高効率製品だけを作ることはできない

## 決定変数

各製品 i の生産レート x_i（個/min）

- 地域内で複数の製品を同時に生産可能
- 生産する製品の種類数に制限はない
- 各製品の生産レートは非負の実数

## 制約条件

### 1. 鉱石採掘レート制約

各鉱石種別について、全製品の消費量合計が採掘レートを超えてはならない。

```
Σ(製品iの生産量 × 製品iの鉱石j消費量) ≤ 鉱石jの採掘レート
```

対象鉱石:
- 源石鉱
- 紫晶鉱
- 青鉄鉱

採掘レートは [valley4_products.json](../valley4_products.json) および [wuling_products.json](../wuling_products.json) の `mining_rates` を参照。

### 2. 電力収支制約

全製品の生産に必要な電力は、バッテリー生産により賄う必要がある。

```
Σ(製品iの生産量 × 製品iの電力消費) ≤ バッテリー生産量 × バッテリー容量
```

- バッテリーは出荷可能製品であり、鉱石を消費して生産される
- バッテリーを電力として消費する場合、その分は出荷できない
- 電力消費には採掘・栽培・加工の全段階を含む

電力データは [recipes.json](../recipes.json) の `machines` および各製品の生産チェーンから算出。

#### マシン待機電力

マシンは待機中も100%の電力を消費する。そのため:
- 小数点台数での生産は可能（例: 2.25台で13.5/min生産）
- ただし電力は切り上げ台数分を消費（例: 2.25台 → 3台分の電力）
- 中間段階のマシンも同様に切り上げ電力を消費

```
実電力消費 = Σ(ceil(マシン台数_i) × マシン電力_i × 60秒)
```

#### 電力バッファ

生産以外にも電力を消費する設備があるため、余剰電力を確保する必要がある。

| 設備 | 電力(unit/sec) | 配置目安 |
|---|--:|---|
| タレット | 20 | 12台/マップ |
| ジップライン | 5 | 30台/マップ |
| 転送倉庫 | 5 | 最終マシン1台あたり0.5台 |

**マップ別バッファ要件**:
| 地域 | マップ数 | タレット | ジップライン | 転送倉庫 | 合計 |
|---|--:|--:|--:|--:|--:|
| 四号谷地 | 5 | 1,200 | 750 | ※ | 1,950+ |
| 武陵 | 2 | 480 | 300 | ※ | 780+ |

※転送倉庫は最終マシン台数に依存（例: 最終マシン16台 → 転送倉庫8台 → 40 unit/sec）

### 3. 貯蔵上限制約（ソフト制約）

各製品について、貯蔵上限を超えた分は売却できず無駄になる。

```
有効生産量_i = min(製品iの生産量 × 売却間隔, 貯蔵上限)
```

- 貯蔵上限を超えて生産すること自体は可能
- 超過分は消滅し、売却に寄与しない
- 特定の鉱石を使い切るために、一部製品をオーバープロデュースする方が有利なケースもありうる

貯蔵上限は各地域の `storage_limit` を参照。

### 4. 取引券蓄積レート制約

各拠点について、売却する製品の取引券総額が蓄積済み取引券を超えてはならない。

```
Σ(拠点jで売却する製品iの数量 × 製品iの取引価格) ≤ 拠点jの蓄積取引券
蓄積取引券 = min(蓄積レート × ボーナス倍率 × 売却間隔, 蓄積上限)
```

拠点データは各地域JSONの `outposts` を参照。

#### 取引券蓄積レートボーナス

防衛任務の達成とオペレータ派遣により、拠点ごとに蓄積レートを引き上げることができる。

| 地域 | 最大ボーナス |
|---|---|
| 四号谷地 | +40% |
| 武陵 | +30% |

### 5. 拠点-製品制約

各製品は特定の拠点でのみ売却可能。

```
製品iは、outposts[j].products に含まれる拠点jでのみ売却可能
```

### 6. 生産上限制約

一部の製品には生産レートの上限がある（例: 機械設置数制限）。

```
製品iの生産量 ≤ 製品iの生産上限
```

生産上限は各製品の `production_limit` を参照（設定がある場合のみ）。

### 7. 植物・水の制約

植物および水は電力があれば無限に生産可能なため、鉱石のような採掘レート制約はない。ただし栽培・汲み上げに電力を消費するため、電力収支制約には含まれる。

## パラメータ

### 入力パラメータ

| パラメータ | 説明 | データソース |
|---|---|---|
| 売却間隔 T | 12h / 24h / 72h | ユーザー指定 |
| 鉱石採掘レート | 各鉱石の採掘速度 | `*_products.json` |
| 貯蔵上限 | 各アイテムの最大保持数 | `*_products.json` |
| 拠点取引券蓄積レート | 各拠点の取引券蓄積速度 | `*_products.json` |
| 拠点取引券蓄積上限 | 各拠点の最大取引券保持量 | `*_products.json` |
| 製品取引価格 | 各製品の取引券価格 | `*_products.json` |
| 製品原材料消費量 | 各製品の鉱石/植物消費量 | `*_analysis.md` |
| 製品電力消費量 | 各製品の総電力消費量 | `*_analysis.md` |
| 製品実効利益率 | 各製品の単位あたり実効利益 | `*_analysis.md` |
| 製品生産上限 | 機械制限等による上限 | `*_products.json` |

### 出力

#### 1. 生産テーブル

| 製品 | マシン数 | 生産レート(/min) | 源石鉱(/min) | 紫晶鉱(/min) | 青鉄鉱(/min) | 電力(unit/sec) | 単価 |
|---|--:|--:|--:|--:|--:|--:|--:|
| 製品A | 2.25 | 13.5 | 0 | 0 | 540 | 927 | 70 |
| 製品B | 8 | 48 | 480 | 240 | 0 | 620 | 16 |
| ... | | | | | | | |
| **計** | | | **560**(余剰0) | **240**(余剰0) | **1,080**(余剰0) | **2,507** | |

- マシン数: 生産レートを実現するのに必要な最終段製作機の台数
- 鉱石消費: 採掘・加工の全段階を含む総消費量、計行に余剰を併記
- 電力消費: 採掘・栽培・加工の全段階を含む総電力消費

#### 2. 電力割当

| バッテリー種別 | 生産レート | 電力用 | 出荷用 |
|---|--:|--:|--:|
| 小容量バッテリー | 48/min | 16/min | 32/min |

- 電力用: 生産に必要な電力を賄うために消費するバッテリー数
- 出荷用: 取引券として売却可能なバッテリー数

#### 3. サマリー

| 項目 | 値 |
|---|--:|
| **取引券生産レート** | **2,482 券/min** |
| 電力供給 | 2,667 unit/sec |
| 電力消費 | 2,507 unit/sec |
| **電力収支** | **+160 unit/sec** |

#### 4. 取引券内訳

| 製品 | 出荷レート | 単価 | 券/min |
|---|--:|--:|--:|
| 製品A | 13.5 | 70 | 945 |
| 製品B | 32 | 16 | 512 |
| **合計** | | | **2,482** |

#### 5. 売却間隔別の実効レート

| 間隔 | 生産券 | 貯蔵損失 | 蓄積上限 | 実効売却 | **実効レート** |
|---|--:|--:|--:|--:|--:|
| 12h | 1,787,040 | 0 | 9,000,000 | 1,787,040 | **2,482/min** |
| 24h | 3,574,080 | 35,200 | 9,000,000 | 3,538,880 | **2,458/min** |
| 72h | 10,722,240 | 1,197,440 | 9,000,000 | 9,000,000 | **2,083/min** |

- 貯蔵損失: 貯蔵上限を超過して消滅した製品の取引券価値
- 蓄積上限: 全拠点の取引券蓄積上限の合計
- 実効売却: min(生産券 - 貯蔵損失, 蓄積上限)

## 問題の特性

### 線形計画問題

- 目的関数: 線形（各製品の利益率 × 生産量の和）
- 制約条件: すべて線形不等式
- 決定変数: 連続変数（生産レート）

### 支配的制約の候補

問題のボトルネックとなりうる制約:

1. **鉱石採掘レート**: 鉱石消費の激しい製品を多く作ると律速
2. **電力収支**: 電力消費が大きい製品群は、バッテリー生産に鉱石を割く必要
3. **取引券蓄積レート**: 高単価製品を大量生産しても、販売が追いつかない
4. **貯蔵上限**: 低単価製品を長期間蓄積すると頭打ち
5. **生産上限**: 特定製品（例: 息壌）は機械制限で律速

### 地域間の独立性

- 各地域は独立した最適化問題として解ける
- 地域間転送は非常に低速なため、実質的に考慮不要
- 電力（バッテリー）の地域間移動も非現実的

## 解法アプローチ

### 手順

1. 各地域について独立に最適化
2. 鉱石消費と電力収支を同時に満たすポートフォリオを探索
3. 取引券蓄積レートで販売可能かを検証
4. 貯蔵上限制約を売却間隔ごとに適用
5. 拠点-製品制約に基づき売却計画を割当

### 考慮すべきトレードオフ

- **バッテリー生産 vs 出荷**: バッテリーを電力として消費すると出荷できない
- **高効率製品 vs 鉱石バランス**: 最高効率製品が特定鉱石に偏ると他が余る
- **生産レート vs 貯蔵**: 長期放置では低単価製品の貯蔵が問題に

## 次のステップ

1. 各製品の詳細な原材料消費量と電力消費量を表形式で整理
2. 地域ごとに線形計画問題を定式化
3. 売却間隔（12h/24h/72h）ごとに最適解を導出
4. 結果を分析し、推奨ポートフォリオを文書化
